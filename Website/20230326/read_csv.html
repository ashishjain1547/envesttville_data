<script src="https://code.jquery.com/jquery-3.6.4.js" integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
    crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.js"> </script>

<script src="./read_csv.js"> </script>

<link rel="stylesheet" href="./styles.css">

<body data-bind='template: { afterRender: getData }'>
    <table>
        <thead>
            <tr>
                <th>
                    Sno.
                </th>

                <th>Builder
                    <br>
                    <input data-bind="value: builderFilterValue, valueUpdate: 'afterkeydown'" />
                </th>

                <th>
                    Property Name
                    <br>
                    <input data-bind="value: propertyFilterValue, valueUpdate: 'afterkeydown'" />
                </th>

                <th>
                    BHK <br>
                    <button data-bind="click: bhkSorting">Sort</button>
                </th>

                <th>
                    Servant Room
                </th>

                <th>
                    Area (Sqft)
                    <br>
                    <button data-bind="click: areaSorting">Sort</button>
                </th>

                <th>
                    Construction
                    <br>
                    <input data-bind="value: constructionFilterValue, valueUpdate: 'afterkeydown'" />
                </th>

                <th>
                    Rate (INR / Sqft)
                    <br>
                    <button data-bind="click: rateSorting">Sort</button>
                </th>

                <th>
                    City
                    <br>
                    <input data-bind="value: cityFilterValue, valueUpdate: 'afterkeydown'" />
                </th>
            </tr>
        </thead>
    </table>

    <table>
        <tbody>
            <!-- ko foreach: tableDataList -->
            <tr>
                <td class="customImg" data-bind="style: {backgroundImage: ImageSrc}"></td>
                <td># <span data-bind="text: $index() + 1"></span></td>
                <td>Builder: <span data-bind="text: Builder"></span></td>
                <td data-bind="text: PropertyName"></td>
                <td>BHK: <span data-bind="text: BHK"></span></td>
                <td>Servant's Room: <span data-bind="text: ServantRoom"></span></td>
                <td>Area (Sqft): <span data-bind="text: Area"></span></td>
                <td data-bind="text: Construction"></td>
                <td>Rate (Rs/Sqft): <span data-bind="text: Rate"></span></td>
                <td data-bind="text: City"></td>
            </tr>
            <!-- /ko -->
        </tbody>
    </table>


</body>


<script>
    url = "https://raw.githubusercontent.com/ashishjain1547/envesttville_data/main/Inventory.csv"

    sep = ";"

    let viewModel = function () {
        self = this;




        self.tableDataList = ko.observableArray();
        self.FilterTblGridArr = ko.observableArray();

        self.tableDataItemViewModel = function (item) {
            var self = this;
            this.Builder = ko.observable(item.Builder);
            this.PropertyName = ko.observable(item.PropertyName);
            this.BHK = ko.observable(item.BHK);
            this.ServantRoom = ko.observable(item.ServantRoom);
            this.Area = ko.observable(item.Area);
            this.Construction = ko.observable(item.Construction);
            this.Rate = ko.observable(item.Rate);
            this.City = ko.observable(item.City);
            this.ImageSrc = ko.observable("url('" + item.ImageSrc + "')");
        };

        self.getData = function () {
            $.get(url, function (csv_data) {
                data = read_csv(csv_data, sep);

                self.tableDataList($.map(data, function (item) {
                    return new self.tableDataItemViewModel(item);
                }));

                self.FilterTblGridArr(self.tableDataList());
            });
        };


        this.builderFilterValue = ko.observable();
        this.builderFilterArray = ko.computed(function () {
            var builderFilter = self.builderFilterValue();
            self.tableDataList([]);
            if (!builderFilter || builderFilter === "") {
                self.tableDataList(self.FilterTblGridArr());
            } else {
                var data = ko.utils.arrayFilter(self.FilterTblGridArr(), function (elem) {
                    return elem.Builder().toLowerCase().indexOf(builderFilter.toLowerCase()) !== -1;
                });
                self.tableDataList(data);
            }
        });

        this.propertyFilterValue = ko.observable();
        this.propertyFilterArray = ko.computed(function () {
            var propertyNameFilter = self.propertyFilterValue();
            self.tableDataList([]);
            if (!propertyNameFilter || propertyNameFilter === "") {
                self.tableDataList(self.FilterTblGridArr());
            } else {
                var data = ko.utils.arrayFilter(self.FilterTblGridArr(), function (elem) {
                    return elem.PropertyName().toLowerCase().indexOf(propertyNameFilter.toLowerCase()) !== -1;
                });
                self.tableDataList(data);
            }
        });

        this.constructionFilterValue = ko.observable();
        this.constructionFilterArray = ko.computed(function () {
            var constructionNameFilter = self.constructionFilterValue();
            self.tableDataList([]);
            if (!constructionNameFilter || constructionNameFilter === "") {
                self.tableDataList(self.FilterTblGridArr());
            } else {
                var data = ko.utils.arrayFilter(self.FilterTblGridArr(), function (elem) {
                    return elem.Construction().toLowerCase().indexOf(constructionNameFilter.toLowerCase()) !== -1;
                });
                self.tableDataList(data);
            }
        });

        

        this.cityFilterValue = ko.observable();
        this.cityFilterArray = ko.computed(function () {
            var cityFilter = self.propertyFilterValue();
            self.tableDataList([]);
            if (!cityFilter || cityFilter === "") {
                self.tableDataList(self.FilterTblGridArr());
            } else {
                var data = ko.utils.arrayFilter(self.FilterTblGridArr(), function (elem) {
                    return elem.City().toLowerCase().indexOf(cityFilter.toLowerCase()) !== -1;
                });
                self.tableDataList(data);
            }
        });



        this.isBHKSortingOrder = ko.observable(true);
        this.bhkSorting = function () {
            var data = self.tableDataList();
            if (self.isBHKSortingOrder()) {
                data.sort(function (a, b) {
                    var aID = a.BHK();
                    var bID = b.BHK();
                    return (aID === bID) ? 0 : (aID > bID) ? 1 : -1;
                });
                self.isBHKSortingOrder(false);
            } else {
                data.sort(function (a, b) {
                    var aID = a.BHK();
                    var bID = b.BHK();
                    return (aID === bID) ? 0 : (aID > bID) ? -1 : 1;
                });
                self.isBHKSortingOrder(true);
            }
            self.tableDataList(data);
        };


        this.isAreaSortingOrder = ko.observable(true);
        this.areaSorting = function () {
            var data = self.tableDataList();
            if (self.isAreaSortingOrder()) {
                data.sort(function (a, b) {
                    var aID = parseFloat(a.Area());
                    var bID = parseFloat(b.Area());
                    return (aID === bID) ? 0 : (aID > bID) ? 1 : -1;
                });
                self.isAreaSortingOrder(false);
            } else {
                data.sort(function (a, b) {
                    var aID = parseFloat(a.Area());
                    var bID = parseFloat(b.Area());
                    return (aID === bID) ? 0 : (aID > bID) ? -1 : 1;
                });
                self.isAreaSortingOrder(true);
            }
            self.tableDataList(data);
        };

        this.isRateSortingOrder = ko.observable(true);
        this.rateSorting = function () {
            var data = self.tableDataList();
            if (self.isRateSortingOrder()) {
                data.sort(function (a, b) {
                    var aID = parseFloat(a.Rate());
                    var bID = parseFloat(b.Rate());
                    return (aID === bID) ? 0 : (aID > bID) ? 1 : -1;
                });
                self.isRateSortingOrder(false);
            } else {
                data.sort(function (a, b) {
                    var aID = parseFloat(a.Rate());
                    var bID = parseFloat(b.Rate());
                    return (aID === bID) ? 0 : (aID > bID) ? -1 : 1;
                });
                self.isRateSortingOrder(true);
            }
            self.tableDataList(data);
        };

    }

    ko.applyBindings(viewModel)

</script>